var exec = require('child_process').exec;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
const fs = require('fs');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
const path = require('path');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
var argv = require("optimist").argv;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
var audio_file_name = (argv.a);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
const wavFilename = audio_file_name.split("/").pop();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
audio_file_name = wavFilename;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
var transcriptData = require(argv.j);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
//var proc = require("child_process");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
var proc = require('child_process').execSync;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
var startTime = endTime = '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
var call_id = path.basename(argv.j).replace(/\.[^/.]+$/, "");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
const firstKey = Object.keys(transcriptData)[0];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
// Now access `data`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
const dataField = transcriptData[firstKey].data;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
var cmd = "ffmpeg -y -i "+ `"${audio_file_name}\"`;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
var flag = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
let filterChain = '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
let first = true;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
dataField.map(function(v,ii,e){                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
        if (v.word == '*' ||v.word == 'yactraq' || v.word == "john" || v.word == "doe")//&& e[ii+1].word == '*')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                if (startTime == '')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                        startTime = (ii || ii == 1)? v.time : (ii > 2) ? e[ii-2].time : v.time;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                        endTime = '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
        else                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                endTime = (ii == e.length -1) ? v.time : (e[ii+3]) ? e[ii+3].time : (e[ii+2]) ? e[ii+2].time : (e[ii+1]) ? e[ii+1].time : v.time;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                if (startTime != '') {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                        //console.log(endTime)//startTime,endTime)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                        flag = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                        if (first) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                filterChain += `volume=enable='between(t,${startTime},${endTime})':volume=0`;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                first = false; // After the first filter, no need to wrap it in quotes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                        } else {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                filterChain += `, volume=enable='between(t,${startTime},${endTime})':volume=0`;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                startTime = '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
        if(dataField.length - 1 == ii)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                if (filterChain) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                        cmd += ` -af "${filterChain}"`; // Add filter chain to the command                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                // Add the output file name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                cmd += ` "${call_id}.wav"`;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                console.log(cmd);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                exec(cmd, (error, stdout, stderr) => {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                        if (error) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                console.error("Error during ffmpeg processing:", error);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                return;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                        console.log("Audio processing complete, now uploading...");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                        // Once ffmpeg processing is complete, upload the file                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                        const upload_command = `aws s3 cp "${call_id}.wav" "s3://homestarsyt/redactedaudio/${call_id}.wav"`;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                        exec(upload_command, (error, stdout, stderr) => {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                if (error) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                        console.error("Error during upload:", error);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                        return;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                console.log("Upload complete:", stdout);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                fs.unlink(`${call_id}.wav`, (err) => {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                        if (err) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                console.error(`Error deleting processed file ${call_id}.wav:`, err);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                console.log(`Successfully deleted processed file: ${call_id}.wav`);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                        // Delete the original audio file                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                        fs.unlink(audio_file_name, (err) => {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                if (err) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                        console.error(`Error deleting original file ${audio_file_name}:`, err);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                } else {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                        console.log(`Successfully deleted original file: ${audio_file_name}`);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                        });                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                });                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                        });                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                });                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
});                                                  